<div class="periode-select">
  <span>P√©riode :</span>
  @for (periode of ['P1','P2','P3','P4','P5']; track periode) {
    <label class="periode-label periode-{{periode}}">
      <input type="radio" name="periode" [value]="periode" [checked]="selectedPeriode() === periode" (change)="selectedPeriode.set(periode)" title="Choisir la p√©riode {{ periode }}" /> {{ periode }}
    </label>
  }
  <button class="save-btn secondary-btn" (click)="savePeriodeActivites()">Enregistrer</button>
</div>

<!-- Toast notification -->
@if (notification()) {
  <div class="toast-notification" [ngClass]="notificationColor() === 'success' ? 'toast-success' : 'toast-error'">
    {{ notification() }}
  </div>
}

<div class="generate-block">
  <button class="generate-btn" (click)="generateDocx()">G√©n√©rer le document pour tous les √©l√®ves</button>
</div>


<div class="status small-status" [ngClass]="status()">
  @if (status() === 'ko') {
    <span class="ko">Connexion KO</span>
  }
  @if (status() === null) {
    <span>V√©rification de la connexion...</span>
  }
</div>

<div class="eleve-select">
  <span>√âl√®ve :</span>
  <select [(ngModel)]="selectedEleve" title="S√©lectionner un √©l√®ve" class="eleve-select-dropdown">
    <option [ngValue]="null">-- S√©lectionner un √©l√®ve --</option>
    @for (eleve of eleves(); track eleve.id) {
      <option [ngValue]="eleve.id">{{ getClasseIcon(eleve.classe || 'Petit') }} {{ eleve.prenom }}</option>
    }
  </select>
  <style>
    .eleve-select {
      margin-bottom: 1.5rem;
    }
  </style>
</div>

@if (!selectedEleve()) {
  <div class="no-eleve-message">
    <p>üëÜ Veuillez s√©lectionner un √©l√®ve pour voir ses activit√©s</p>
  </div>
}

@if (selectedEleve() && categories().length > 0) {
  <div class="tabs">
    @for (cat of categories(); track cat.id) {
      <button [ngClass]="{active: selectedTab() === cat.id}" 
              [style.background-color]="cat.couleur || '#e0e0e0'"
              [style.color]="selectedTab() === cat.id ? '#000' : '#333'"
              [style.border]="selectedTab() === cat.id ? '2px solid #333' : '1px solid rgba(0,0,0,0.2)'"
              (click)="selectedTab.set(cat.id)">{{ formatCategorieLibelle(cat.libelle) }}</button>
    }
  </div>

  <div class="tab-content">
    @if (selectedTab()) {
      @if (getActivitesForSelectedCategorie().length > 0) {
        <div class="activites-list">
          @for (activite of getActivitesForSelectedCategorie(); track activite.id) {
            <div class="activite-item" [ngClass]="getActiviteItemClass(activite)">
              @if (activite.estRegroupement) {
                <!-- Regroupement - non cochable -->
                <div class="regroupement-header">
                  <span class="regroupement-icon">üìÅ</span>
                  <span class="regroupement-label">{{ activite.libelleCourt }}</span>
                </div>
                <!-- Activit√©s enfants -->
                @for (enfant of getEnfantsForActivite(activite.id); track enfant.id) {
                  <div class="activite-enfant">
                    <span class="indent">‚îî‚îÄ</span>
                    <input type="checkbox" [id]="'activite-' + enfant.id" [value]="enfant.id" [(ngModel)]="selectedActivites[enfant.id]" (ngModelChange)="onActiviteChange()" title="S√©lectionner l'activit√© {{ enfant.libelleCourt }}" />
                    <label [for]="'activite-' + enfant.id" [ngClass]="getPeriodeForActivite(enfant.id) ? 'activite-highlight-' + getPeriodeForActivite(enfant.id) : ''">{{ enfant.libelleCourt }}</label>
                  </div>
                }
              } @else if (!activite.parentId) {
                <!-- Activit√© isol√©e -->
                @if (activite.estParametrable) {
                  <!-- Activit√© param√©trable -->
                  <div class="activite-parametrable">
                    <input type="checkbox" [id]="'activite-' + activite.id" [value]="activite.id" [(ngModel)]="selectedActivites[activite.id]" (ngModelChange)="onActiviteChange()" title="S√©lectionner l'activit√© {{ activite.libelleCourt }}" />
                    <label [for]="'activite-' + activite.id" [ngClass]="getPeriodeForActivite(activite.id) ? 'activite-highlight-' + getPeriodeForActivite(activite.id) : ''">{{ activite.libelleCourt }}</label>
                    
                    @if (selectedActivites[activite.id]) {
                      <div class="parametres-zone">
                        <div class="template-preview">{{ getLibelleAvecParametres(activite) }}</div>
                        @for (param of activite.nomsParametres || []; track param) {
                          <input type="text" 
                                 class="parametre-input"
                                 [ngModel]="getParametreValue(activite.id, param)"
                                 (ngModelChange)="setParametreValue(activite.id, param, $event)"
                                 [placeholder]="'Saisir ' + param" />
                        }
                      </div>
                    }
                  </div>
                } @else {
                  <!-- Activit√© normale -->
                  <input type="checkbox" [id]="'activite-' + activite.id" [value]="activite.id" [(ngModel)]="selectedActivites[activite.id]" (ngModelChange)="onActiviteChange()" title="S√©lectionner l'activit√© {{ activite.libelleCourt }}" />
                  <label [for]="'activite-' + activite.id" [ngClass]="getPeriodeForActivite(activite.id) ? 'activite-highlight-' + getPeriodeForActivite(activite.id) : ''">{{ activite.libelleCourt }}</label>
                }
              }
            </div>
          }
        </div>
      }
      @else {
        <div class="no-activite">pas d'activit√©s encore ...</div>
      }
    }
  </div>
}
