<div class="container">
  <h2>Gestion des activit√©s</h2>
  
  @if (error()) {
    <div class="error">{{ error() }}</div>
  }

  <!-- Structure hi√©rarchique des activit√©s -->
  <div class="activites-hierarchy">
    <h3>Structure des activit√©s</h3>
    
    <!-- Liste mixte des regroupements et activit√©s isol√©es -->
    <div cdkDropList 
         (cdkDropListDropped)="onDropElementsPrincipaux($event)"
         class="elements-principaux-list">
      @for (element of elementsPrincipaux; track element.id) {
        @if (element.estRegroupement) {
          <!-- Regroupement -->
          <div class="regroupement" cdkDrag>
            <div class="regroupement-header" [class.editing]="selected()?.id === element.id">
              <div class="drag-handle" cdkDragHandle>‚ãÆ‚ãÆ</div>
              @if (selected() && selected()?.id === element.id) {
                <div class="edit-form">
                  <input [formControl]="editLibelleCourt" placeholder="Libell√© court du regroupement" />
                  <input [formControl]="editLibelleLong" placeholder="Libell√© long du regroupement" />
                  <select [formControl]="editCategorieId">
                    <option value="" disabled>Choisir une cat√©gorie</option>
                    @for (cat of categories(); track cat.id) {
                      <option [value]="cat.id">{{ cat.libelle }}</option>
                    }
                  </select>
                  <button class="btn-save" (click)="save()">Enregistrer</button>
                  <button class="btn-cancel" (click)="cancel()">Annuler</button>
                </div>
              } @else {
                <div class="regroupement-info">
                  <span class="regroupement-icon">üìÅ</span>
                  <span class="libelle">{{ element.libelleCourt }} - {{ element.libelleLong }}</span>
                  <span class="categorie">({{ getCategorieLibelle(element.categorieId) }})</span>
                  <div class="actions">
                    <button class="btn-edit" (click)="select(element)">Modifier</button>
                    <button class="btn-delete" (click)="deleteActivite(element.id)">Supprimer</button>
                    <button class="btn-add-child" (click)="startAddingToRegroupement(element.id)">+ Activit√©</button>
                  </div>
                </div>
              }
            </div>
            
            <!-- Activit√©s enfants -->
            <div class="activites-enfants" 
                 cdkDropList 
                 (cdkDropListDropped)="onDropEnfants($event, element.id)">
              @for (enfant of getEnfants(element.id); track enfant.id) {
                <div class="activite-enfant" 
                     [class.editing]="selected()?.id === enfant.id"
                     cdkDrag>
                  @if (selected() && selected()?.id === enfant.id) {
                    <div class="edit-form">
                      <span class="indent">‚îî‚îÄ</span>
                      <input [formControl]="editLibelleCourt" placeholder="Libell√© court" />
                      <input [formControl]="editLibelleLong" placeholder="Libell√© long" />
                      <button class="btn-save" (click)="save()">Enregistrer</button>
                      <button class="btn-cancel" (click)="cancel()">Annuler</button>
                    </div>
                  } @else {
                    <div class="activite-info">
                      <div class="drag-handle" cdkDragHandle>‚ãÆ‚ãÆ</div>
                      <span class="indent">‚îî‚îÄ</span>
                      <span class="libelle">{{ enfant.libelleCourt }} - {{ enfant.libelleLong }}</span>
                      <div class="actions">
                        <button class="btn-edit" (click)="select(enfant)">Modifier</button>
                        <button class="btn-delete" (click)="deleteActivite(enfant.id)">Supprimer</button>
                      </div>
                    </div>
                  }
                </div>
              }
              
              <!-- Formulaire d'ajout d'activit√© dans le regroupement -->
              @if (addingToRegroupement() === element.id) {
                <div class="add-activite-form">
                  <span class="indent">‚îî‚îÄ</span>
                  <input [formControl]="addLibelleCourt" placeholder="Libell√© court" />
                  <input [formControl]="addLibelleLong" placeholder="Libell√© long" />
                  <button class="btn-save" (click)="addActiviteToRegroupement(element.id)">Ajouter</button>
                  <button class="btn-cancel" (click)="cancelAddingToRegroupement()">Annuler</button>
                </div>
              }
            </div>
          </div>
        } @else {
          <!-- Activit√© isol√©e -->
          <div class="activite-isolee" 
               [class.editing]="selected()?.id === element.id"
               cdkDrag>
            @if (selected() && selected()?.id === element.id) {
              <div class="edit-form">
                <input [formControl]="editLibelleCourt" placeholder="Libell√© court" />
                <input [formControl]="editLibelleLong" placeholder="Libell√© long" />
                <select [formControl]="editCategorieId">
                  <option value="" disabled>Choisir une cat√©gorie</option>
                  @for (cat of categories(); track cat.id) {
                    <option [value]="cat.id">{{ cat.libelle }}</option>
                  }
                </select>
                <button class="btn-save" (click)="save()">Enregistrer</button>
                <button class="btn-cancel" (click)="cancel()">Annuler</button>
              </div>
            } @else {
              <div class="activite-info">
                <div class="drag-handle" cdkDragHandle>‚ãÆ‚ãÆ</div>
                <span class="activite-icon">üìÑ</span>
                <span class="libelle">{{ element.libelleCourt }} - {{ element.libelleLong }}</span>
                <span class="categorie">({{ getCategorieLibelle(element.categorieId) }})</span>
                <div class="actions">
                  <button class="btn-edit" (click)="select(element)">Modifier</button>
                  <button class="btn-delete" (click)="deleteActivite(element.id)">Supprimer</button>
                </div>
              </div>
            }
          </div>
        }
      }
    </div>
  </div>  <!-- Formulaires d'ajout -->
  <div class="add-forms">
    <h3>Ajouter</h3>
    
    <!-- Ajouter un regroupement -->
    <div class="add-regroupement">
      <h4>Nouveau regroupement</h4>
      <div class="form-row">
        <input [formControl]="addRegroupementLibelleCourt" placeholder="Libell√© court du regroupement" />
        <input [formControl]="addRegroupementLibelleLong" placeholder="Libell√© long du regroupement" />
        <select [formControl]="addRegroupementCategorieId">
          <option value="" disabled selected>Choisir une cat√©gorie</option>
          @for (cat of categories(); track cat.id) {
            <option [value]="cat.id">{{ cat.libelle }}</option>
          }
        </select>
        <button class="btn-add" (click)="addRegroupement()">Cr√©er regroupement</button>
      </div>
    </div>

    <!-- Ajouter une activit√© isol√©e -->
    <div class="add-activite-isolee">
      <h4>Nouvelle activit√© isol√©e</h4>
      <div class="form-row">
        <input [formControl]="addLibelleCourt" placeholder="Libell√© court" />
        <input [formControl]="addLibelleLong" placeholder="Libell√© long" />
        <select [formControl]="addCategorieId">
          <option value="" disabled selected>Choisir une cat√©gorie</option>
          @for (cat of categories(); track cat.id) {
            <option [value]="cat.id">{{ cat.libelle }}</option>
          }
        </select>
        <button class="btn-add" (click)="addActiviteIsolee()">Ajouter activit√©</button>
      </div>
    </div>
  </div>
</div>
